@{
    ViewData["Title"] = "Hellenic Fire Service Incidents Map";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3">
            <!-- Filters Card -->
            <div class="card filter-card">
                <div class="card-header">
                    <h5 data-translate="filters">Filters</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label section-title" data-translate="status">Status</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="ΣΕ ΕΞΕΛΙΞΗ" id="ongoingCheck" checked>
                            <label class="form-check-label status-ongoing" for="ongoingCheck" data-translate="inProgress">
                                ΣΕ ΕΞΕΛΙΞΗ (In Progress)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="ΜΕΡΙΚΟΣ ΕΛΕΓΧΟΣ" id="partialControlCheck" checked>
                            <label class="form-check-label status-partial" for="partialControlCheck" data-translate="partialControl">
                                ΜΕΡΙΚΟΣ ΕΛΕΓΧΟΣ (Partial Control)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="ΠΛΗΡΗΣ ΕΛΕΓΧΟΣ" id="fullControlCheck">
                            <label class="form-check-label status-controlled" for="fullControlCheck" data-translate="fullControl">
                                ΠΛΗΡΗΣ ΕΛΕΓΧΟΣ (Full Control)
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-translate="category">Category</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="ΔΑΣΙΚΕΣ ΠΥΡΚΑΓΙΕΣ" id="forestFiresCheck" checked>
                            <label class="form-check-label" for="forestFiresCheck" data-translate="forestFires">
                                ΔΑΣΙΚΕΣ ΠΥΡΚΑΓΙΕΣ (Forest Fires)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="ΑΣΤΙΚΕΣ ΠΥΡΚΑΓΙΕΣ" id="urbanFiresCheck" checked>
                            <label class="form-check-label" for="urbanFiresCheck" data-translate="urbanFires">
                                ΑΣΤΙΚΕΣ ΠΥΡΚΑΓΙΕΣ (Urban Fires)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="ΠΑΡΟΧΕΣ ΒΟΗΘΕΙΑΣ" id="assistanceCheck" checked>
                            <label class="form-check-label" for="assistanceCheck" data-translate="assistance">
                                ΠΑΡΟΧΕΣ ΒΟΗΘΕΙΑΣ (Assistance)
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label section-title" data-translate="districts">Districts</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="fireDistrictsCheck" disabled>
                            <label class="form-check-label" for="fireDistrictsCheck" data-translate="showFireDistricts">
                                Show Fire Department Districts
                            </label>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button id="refreshBtn" class="btn btn-primary">
                            <i class="fas fa-sync-alt me-1"></i> <span data-translate="refresh">Refresh Data</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Card -->
            <div class="card mt-3 stats-card">
                <div class="card-header">
                    <h5 data-translate="statistics">Statistics</h5>
                </div>
                <div class="card-body">
                    <div id="statistics">
                        <div class="stat-item">
                            <span class="stat-label" data-translate="totalIncidents">Total Incidents:</span>
                            <span class="stat-value" id="totalIncidents">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-translate="forestFireCount">Forest Fires:</span>
                            <span class="stat-value" id="forestFireCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-translate="urbanFireCount">Urban Fires:</span>
                            <span class="stat-value" id="urbanFireCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" data-translate="assistanceCount">Assistance:</span>
                            <span class="stat-value" id="assistanceCount">0</span>
                        </div>
                        @if (ViewBag.Show112Warnings == true)
                        {
                            <div class="stat-item">
                                <span class="stat-label" data-translate="warningsCount">112 Warnings:</span>
                                <span class="stat-value warning-stat" id="warningsCount">0</span>
                            </div>
                        }
                        <div class="stat-item last-updated">
                            <span class="stat-label" data-translate="lastUpdated">Last Updated:</span>
                            <span class="stat-value" id="lastUpdated">Never</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legend Card -->
            <div class="card mt-3 legend-card">
                <div class="card-header">
                    <h5 data-translate="legend">Legend</h5>
                </div>
                <div class="card-body">
                    <div class="legend-item">
                        <img src="~/images/markers/forest-fire-ongoing.png" width="24" height="24" />
                        <span data-translate="forestFireInProgress">Forest Fire - In Progress</span>
                    </div>
                    <div class="legend-item">
                        <img src="~/images/markers/forest-fire-partial.png" width="24" height="24" />
                        <span data-translate="forestFirePartial">Forest Fire - Partial Control</span>
                    </div>
                    <div class="legend-item">
                        <img src="~/images/markers/forest-fire-controlled.png" width="24" height="24" />
                        <span data-translate="forestFireControlled">Forest Fire - Full Control</span>
                    </div>
                    <div class="legend-item">
                        <img src="~/images/markers/urban-fire-ongoing.png" width="24" height="24" />
                        <span data-translate="urbanFireInProgress">Urban Fire - In Progress</span>
                    </div>
                    <div class="legend-item">
                        <img src="~/images/markers/urban-fire-partial.png" width="24" height="24" />
                        <span data-translate="urbanFirePartial">Urban Fire - Partial Control</span>
                    </div>
                    <div class="legend-item">
                        <img src="~/images/markers/urban-fire-controlled.png" width="24" height="24" />
                        <span data-translate="urbanFireControlled">Urban Fire - Full Control</span>
                    </div>
                    <div class="legend-item">
                        <img src="~/images/markers/assistance-ongoing.png" width="24" height="24" />
                        <span data-translate="assistanceInProgress">Assistance - In Progress</span>
                    </div>
                    <div class="legend-item">
                        <img src="~/images/markers/assistance-partial.png" width="24" height="24" />
                        <span data-translate="assistancePartial">Assistance - Partial Control</span>
                    </div>
                    <div class="legend-item">
                        <img src="~/images/markers/assistance-controlled.png" width="24" height="24" />
                        <span data-translate="assistanceControlled">Assistance - Full Control</span>
                    </div>
                    @if (ViewBag.Show112Warnings == true)
                    {
                        <div class="legend-separator">
                            <hr><strong data-translate="emergencyWarnings">Emergency Warnings</strong>
                        </div>
                        <div class="legend-item">
                            <img src="~/images/markers/112warning_red.png" width="24" height="24" />
                            <span data-translate="warning112Active">112 Warning - Active (0-12h)</span>
                        </div>
                        <div class="legend-item">
                            <img src="~/images/markers/112warning_yellow.png" width="24" height="24" />
                            <span data-translate="warning112Expiring">112 Warning - Expiring (12-24h)</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card map-card">
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>

            <!-- Fire Risk Map -->
            <div class="d-flex justify-content-center my-3">
                <button id="btnShowMap" class="btn btn-primary">
                    <i class="fas fa-map me-1"></i>
                    <span data-translate="civilmap">Show Latest Civil Protection Map</span>
                </button>
            </div>

            <!-- X (Twitter) feeds row -->
            <div class="row g-3 mt-2" id="xFeedsRow">
                <!-- Left: 112Greece -->
                <div class="col-md-6">
                    <div class="twitter-feed-container h-100">
                        <div class="twitter-feed-header">
                            <i class="fas fa-exclamation-triangle text-danger"></i>
                            @("112") Greece — Live feed
                        </div>
                        <div class="twitter-feed-content" id="feed-112greece">
                            <div class="twitter-feed-loading">
                                <div class="spinner-border text-danger" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading emergency alerts...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: pyrosvestiki  -->
                <div class="col-md-6">
                    <div class="twitter-feed-container h-100">
                        <div class="twitter-feed-header">
                            <i class="fas fa-fire text-warning"></i>
                            Πυροσβεστική — Live feed
                        </div>
                        <div class="twitter-feed-content" id="feed-pyrosvestiki">
                            <div class="twitter-feed-loading">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading fire service updates...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Incident Details Modal -->
<div class="modal fade" id="incidentModal" tabindex="-1" aria-labelledby="incidentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="incidentModalLabel" data-translate="incidentDetails">Incident Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="incidentModalBody">
                <!-- Incident details will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="close">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Civil Protection Map -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel" data-translate="civilmap">Civil Protection Map</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="mapImage" src="" alt="Civil Protection Map" style="max-width:100%; max-height:70vh;" />
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="~/css/twitter-feeds.css" asp-append-version="true" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="~/js/map.js" asp-append-version="true"></script>

    <!--Fire Risk Map-->
    <script>
        const btnShowMap = document.getElementById('btnShowMap');
        const btnTextSpan = btnShowMap.querySelector('span[data-translate="civilmap"]');

        btnShowMap.addEventListener('click', async function () {
            btnShowMap.disabled = true;
            btnTextSpan.setAttribute('data-translate', 'loading');
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }             

            try {
                const response = await fetch('@Url.Action("GetLatestMapImageUrl", "CivilProtectionMap")');
                const data = await response.json();

                if (data.imageUrl) {
                    document.getElementById('mapImage').src = data.imageUrl;
                    var modal = new bootstrap.Modal(document.getElementById('mapModal'));
                    modal.show();
                } else {
                    alert('Failed to load the civil protection map image.');
                }
            } catch (e) {
                alert('Error loading map image.');
            }

            btnShowMap.disabled = false;
            btnTextSpan.setAttribute('data-translate', 'civilmap');
            if (typeof applyTranslations === 'function') applyTranslations();
        });

        // Custom Twitter Feed Implementation
        (function () {
            // RSS Feed URLs
            const feedUrls = {
                '112greece': 'https://feeds.livefireincidents.gr/112greece/rss',
                'pyrosvestiki': 'https://feeds.livefireincidents.gr/pyrosvestiki/rss'
            };

            // Profile information
            const profiles = {
                '112greece': {
                    username: '112 Greece',
                    handle: '@@112Greece',
                    avatar: '/images/profiles/112greece.png',
                    verified: true,
                    type: 'emergency'
                },
                'pyrosvestiki': {
                    username: 'Πυροσβεστικό Σώμα',
                    handle: '@@pyrosvestiki',
                    avatar: '/images/profiles/pyrosvestiki.png',
                    verified: true,
                    type: 'fire-service'
                }
            };

            // Load RSS feed with timeout and error handling
            async function loadRSSFeed(feedKey, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;

                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(function() {
                    controller.abort();
                }, 10000); // 10 second timeout

                try {
                    // Use server-side RSS proxy to fetch the RSS feed
                    const proxyUrl = '/Home/RSSProxy?url=';
                    const response = await fetch(proxyUrl + encodeURIComponent(feedUrls[feedKey]), {
                        signal: controller.signal,
                        cache: 'no-cache'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const xmlText = await response.text();
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                        const items = xmlDoc.querySelectorAll('item');
                        
                        if (items.length > 0) {
                            const feedItems = Array.from(items).slice(0, 8).map(item => {
                                let title = item.querySelector('title')?.textContent || 'No title';
                                let description = item.querySelector('description')?.textContent || 'No description';
                                const link = item.querySelector('link')?.textContent || '#';
                                const pubDate = item.querySelector('pubDate')?.textContent || new Date().toISOString();
                                
                                // Filter out 'Image' text from title and description
                                if (title === 'Image' || title.trim() === 'Image') {
                                    title = description !== 'No description' ? description : 'Emergency Alert';
                                    description = 'No description';
                                }
                                
                                return { title, description, link, pubDate };
                            });
                            
                            displayFeedItems(feedItems, containerId, feedKey);
                        } else {
                            displayFeedError(containerId, 'No items found in feed');
                        }
                    } else {
                        displayFeedError(containerId, 'Failed to fetch feed (' + response.status + ')');
                    }
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.warn('Feed request timed out for ' + feedKey);
                        displayFeedError(containerId, 'Feed request timed out');
                    } else {
                        console.error('Error loading ' + feedKey + ' feed:', error);
                        displayFeedError(containerId, 'Failed to load feed');
                    }
                }
            }

            // Display feed items
            function displayFeedItems(items, containerId, feedKey) {
                try {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    
                    const profile = profiles[feedKey];
                    if (!profile) return;
                    
                    let html = '';
                    
                    // Limit items to prevent performance issues
                    const limitedItems = items.slice(0, 6);
                    
                    limitedItems.forEach(function(item, index) {
                    const pubDate = new Date(item.pubDate);
                    const timeAgo = getTimeAgo(pubDate);

                    // Process content for hashtags and mentions
                    let content = item.description && item.description !== 'No description available' && item.description !== 'No description' 
                                    ? item.description 
                                    : (item.title && item.title !== 'Image' && item.title.trim() !== 'Image' 
                                        ? item.title 
                                        : '');

                    // Replace hashtags and mentions with styled versions
                    content = content.replace(/#(\w+)/g, '<span class="hashtag">#$1</span>');
                    content = content.replace(/@@(\w+)/g, '<span class="mention">@@$1</span>');

                    // Process emergency content (no badges above messages)
                    let badges = '';
                    
                    // Extract and style activation numbers (only Activation/Ενεργοποίηση 112)
                    if (content.includes('Activation') || content.includes('Ενεργοποίηση')) {
                        content = content.replace(/(Activation|Ενεργοποίηση)\s*(?:1⃣1⃣2⃣|1️⃣1️⃣2️⃣|112)/g, function(match, prefix) {
                            return prefix + ' <span class="activation-badges">' +
                                '<span class="activation-number">1</span>' +
                                '<span class="activation-number">1</span>' +
                                '<span class="activation-number">2</span>' +
                            '</span>';
                        });
                    }
                    
                    // Style dangerous smoke warnings
                    content = content.replace(/(Dangerous smoke|Επικίνδυνοι καπνοί)/gi, '<span class="emergency-text">$1</span>');
                    content = content.replace(/(Wildfire|Δασική πυρκαγιά|Πυρκαγιά)/gi, '<span class="emergency-text">$1</span>');

                    // Style stay indoors warnings  
                    //content = content.replace(/(Stay indoors|Παραμείνετε σε εσωτερικούς χώρους)/gi, '<span class="warning-text">$1</span>');

                    html += '<div class="tweet-item ' + profile.type + '" data-link="' + item.link + '">' +
                        '<div class="tweet-header">' +
                            '<div class="tweet-avatar">' +
                                '<img src="' + profile.avatar + '" alt="' + profile.username + '" onerror="this.src=\'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2NTc3ODYiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNiIgcj0iNiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTggMzJDOCAyNi40NzcyIDEyLjQ3NzIgMjIgMTggMjJIMjJDMjcuNTIyOCAyMiAzMiAyNi40NzcyIDMyIDMyVjM0SDhWMzJaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K\'">' +
                            '</div>' +
                            '<div class="tweet-user-info">' +
                                '<div class="tweet-username">' +
                                    '<span class="tweet-display-name">' + profile.username + '</span>' +
                                    (profile.verified ? '<i class="fas fa-check-circle tweet-verified"></i>' : '') +
                                    '<span class="tweet-handle">' + profile.handle + '</span>' +
                                    '<span class="tweet-time">' + timeAgo + '</span>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="tweet-content">' +
                            badges + content +
                        '</div>' +
                    '</div>';
                    });
                    
                    container.innerHTML = html;

                    // Add click handlers for tweet items (with error handling)
                    setTimeout(function() {
                        try {
                            const tweetItems = container.querySelectorAll('.tweet-item');
                            tweetItems.forEach(function(item) {
                                item.addEventListener('click', function(e) {
                                    try {
                                        if (e.target.closest('.tweet-actions')) return;
                                        const link = this.dataset.link;
                                        if (link && link !== '#') {
                                            window.open(link, '_blank', 'noopener');
                                        }
                                    } catch (err) {
                                        console.warn('Click handler error:', err);
                                    }
                                });
                            });
                        } catch (err) {
                            console.warn('Event binding error:', err);
                        }
                    }, 100);
                } catch (error) {
                    console.error('Display feed items error:', error);
                    displayFeedError(containerId, 'Error displaying feed');
                }
            }

            // Display feed error
            function displayFeedError(containerId, message) {
                const container = document.getElementById(containerId);
                container.innerHTML = '<div class="twitter-feed-error">' +
                    '<i class="fas fa-exclamation-triangle"></i>' +
                    '<h6>Feed Unavailable</h6>' +
                    '<p>' + message + '</p>' +
                    '<button class="btn btn-outline-primary btn-sm" onclick="loadAllFeeds()">' +
                        '<i class="fas fa-sync-alt me-1"></i>' +
                        'Try Again' +
                    '</button>' +
                '</div>';
            }

            // Get time ago string
            function getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffMins < 1) return 'now';
                if (diffMins < 60) return diffMins + 'm';
                if (diffHours < 24) return diffHours + 'h';
                return diffDays + 'd';
            }

            // Load all feeds with error handling
            window.loadAllFeeds = function() {
                try {
                    // Load feeds with a small delay to prevent overwhelming the server
                    loadRSSFeed('112greece', 'feed-112greece');
                    setTimeout(function() {
                        loadRSSFeed('pyrosvestiki', 'feed-pyrosvestiki');
                    }, 500);
                } catch (error) {
                    console.error('Error in loadAllFeeds:', error);
                }
            };

            // Simple dark theme detection (no mutation observer to prevent freezing)
            function applyDarkTheme() {
                try {
                    const hasBootstrapDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                    const hasThemeDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const hasBodyDark = document.body && document.body.classList.contains('dark');
                    
                    // Only apply dark theme if explicitly set by the application, not system preference
                    const shouldBeDark = hasBootstrapDark || hasThemeDark || hasBodyDark;
                    const currentlyDark = document.documentElement.classList.contains('dark-theme');
                    
                    if (shouldBeDark && !currentlyDark) {
                        document.documentElement.classList.add('dark-theme');
                    } else if (!shouldBeDark && currentlyDark) {
                        document.documentElement.classList.remove('dark-theme');
                    }
                } catch (e) {
                    console.warn('Dark theme detection error:', e);
                }
            }

            // Initialize feeds when page loads
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Twitter feeds initializing...');
                const startTime = performance.now();
                
                try {
                    // Apply initial dark theme detection
                    applyDarkTheme();
                    
                    // Listen for manual theme changes via MutationObserver (debounced)
                    if (window.MutationObserver) {
                        let themeTimeout;
                        const observer = new MutationObserver(function(mutations) {
                            let shouldUpdate = false;
                            mutations.forEach(function(mutation) {
                                if (mutation.type === 'attributes' && 
                                    (mutation.attributeName === 'data-bs-theme' || 
                                     mutation.attributeName === 'data-theme' ||
                                     mutation.attributeName === 'class')) {
                                    shouldUpdate = true;
                                }
                            });
                            
                            if (shouldUpdate) {
                                clearTimeout(themeTimeout);
                                themeTimeout = setTimeout(applyDarkTheme, 100);
                            }
                        });
                        
                        observer.observe(document.documentElement, {
                            attributes: true,
                            attributeFilter: ['data-bs-theme', 'data-theme', 'class']
                        });
                        
                        if (document.body) {
                            observer.observe(document.body, {
                                attributes: true,
                                attributeFilter: ['class']
                            });
                        }
                    }
                    
                    // Load feeds with performance monitoring
                    loadAllFeeds();
                    
                    // Auto-refresh every 1 min
                    setInterval(function() {
                        try {
                            loadAllFeeds();
                        } catch (e) {
                            console.error('Auto-refresh error:', e);
                        }
                    }, 60000);
                    
                    const endTime = performance.now();
                    console.log('Twitter feeds initialized in ' + Math.round(endTime - startTime) + 'ms');
                } catch (e) {
                    console.error('Initialization error:', e);
                    // Fallback: just load feeds without theme detection
                    try {
                        loadAllFeeds();
                    } catch (fallbackError) {
                        console.error('Fallback load error:', fallbackError);
                    }
                }
            });
        })();
    </script>
    
    <script>
        // Pass configuration to JavaScript
        window.appConfig = {
            show112Warnings: @(ViewBag.Show112Warnings.ToString().ToLower())
        };
    </script>
}